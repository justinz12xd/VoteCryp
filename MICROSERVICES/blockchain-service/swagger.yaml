openapi: 3.0.3
info:
  title: VoteCryp Blockchain Service API
  description: |
    # VoteCryp Blockchain Service
    
    Microservicio que act√∫a como puente entre el backend y el smart contract de VoteCryp.
    
    ## üéØ Funcionalidades
    - üó≥Ô∏è Gesti√≥n de votaciones cifradas
    - üìä Consulta de resultados en tiempo real
    - üõ†Ô∏è Administraci√≥n de elecciones
    - üîê Integraci√≥n con FHE (Fully Homomorphic Encryption)
    
    ## üèóÔ∏è Arquitectura
    ```
    Backend ‚Üê‚Üí blockchain-service ‚Üê‚Üí Smart Contract (Lisk)
    ```
    
    ## ‚öôÔ∏è Configuraci√≥n
    - **Puerto por defecto:** 4002
    - **Red blockchain:** Configurable via `RPC_URL`
    - **Autenticaci√≥n:** Private key para operaciones admin
    - **Contract Address:** Direcci√≥n del smart contract desplegado
    
    ## üöÄ Quick Start
    ```bash
    # Verificar estado del servicio
    curl http://localhost:4002/health
    
    # Crear elecci√≥n
    curl -X POST http://localhost:4002/createElection \
      -H "Content-Type: application/json" \
      -d '{"title":"Test","options":["Yes","No"],"durationHours":24}'
    ```
    
  version: 1.0.0
  contact:
    name: VoteCryp Team
    url: https://github.com/justinz12xd/VoteCryp
    email: support@votecryp.com
  license:
    name: MIT
    url: https://opensource.org/licenses/MIT

servers:
  - url: http://localhost:4002
    description: üè† Servidor de desarrollo local
  - url: http://blockchain-service:4002
    description: üê≥ Contenedor Docker
  - url: https://api.votecryp.com/blockchain
    description: üåê Servidor de producci√≥n

paths:
  /health:
    get:
      summary: üîç Health Check
      description: |
        Verifica que el servicio est√© funcionando correctamente.
        
        **Uso:** Ideal para health checks de Docker, load balancers y monitoreo.
      tags:
        - üîç Health
      security: []
      responses:
        '200':
          description: ‚úÖ Servicio funcionando correctamente
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthResponse'
              examples:
                success:
                  summary: Respuesta exitosa
                  value:
                    ok: true
        '500':
          description: ‚ùå Error interno del servicio
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /submitVote:
    post:
      summary: üó≥Ô∏è Enviar Voto Cifrado
      description: |
        Env√≠a un voto cifrado al smart contract.
        
        **Proceso:**
        1. Valida el voto cifrado
        2. Extrae la opci√≥n del voto
        3. Llama al smart contract
        4. Retorna hash de transacci√≥n
        
        **Nota:** El servicio previene double voting autom√°ticamente.
      tags:
        - üó≥Ô∏è Voting
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SubmitVoteRequest'
            examples:
              basicVote:
                summary: Voto b√°sico
                value:
                  electionId: "1"
                  encryptedVote: "encrypted_option_data_0"
                  walletAddress: "0x742d35Cc6601C1C8c7c3c3c3c3c3c3c3c3c3c3c"
              fheVote:
                summary: Voto con FHE
                value:
                  electionId: "2"
                  encryptedVote: "fhe_encrypted_vote_data_1"
                  walletAddress: "0x123456789abcdef123456789abcdef123456789a"
      responses:
        '200':
          description: ‚úÖ Voto enviado exitosamente
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SubmitVoteResponse'
              examples:
                success:
                  summary: Voto registrado
                  value:
                    txHash: "0xaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa"
                    blockNumber: 12345
                    confirmed: true
        '400':
          description: ‚ùå Datos de entrada inv√°lidos
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                missingData:
                  summary: Datos faltantes
                  value:
                    error: "invalid body"
                    details: "Missing required fields: electionId, encryptedVote, walletAddress"
        '500':
          description: ‚ùå Error en blockchain
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /hasVoted:
    get:
      summary: ‚úÖ Verificar Estado de Votaci√≥n
      description: |
        Verifica si una direcci√≥n de wallet ya vot√≥ en una elecci√≥n espec√≠fica.
        
        **Uso:** Llamar antes de permitir votar para prevenir double voting.
      tags:
        - üó≥Ô∏è Voting
      parameters:
        - name: electionId
          in: query
          required: true
          schema:
            type: string
            pattern: '^[0-9]+$'
          description: ID num√©rico de la elecci√≥n
          example: "1"
        - name: address
          in: query
          required: true
          schema:
            type: string
            pattern: '^0x[a-fA-F0-9]{40}$'
          description: Direcci√≥n de wallet Ethereum v√°lida
          example: "0x742d35Cc6634C0532925a3b844Bc454e4438f44e"
      responses:
        '200':
          description: ‚úÖ Estado obtenido exitosamente
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HasVotedResponse'
              examples:
                hasVoted:
                  summary: Usuario ya vot√≥
                  value:
                    hasVoted: true
                hasNotVoted:
                  summary: Usuario no ha votado
                  value:
                    hasVoted: false
        '400':
          description: ‚ùå Par√°metros inv√°lidos
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: ‚ùå Error consultando blockchain
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /getEncryptedResults:
    get:
      summary: üîê Obtener Votos Cifrados
      description: |
        Obtiene todos los votos cifrados almacenados para procesamiento FHE.
        
        **Uso:** Para servicios de tally que necesitan procesar votos cifrados.
      tags:
        - üîê Encryption
      security: []
      responses:
        '200':
          description: ‚úÖ Votos cifrados obtenidos
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/EncryptedResultsResponse'
              examples:
                withVotes:
                  summary: Con votos cifrados
                  value:
                    encryptedResults:
                      - "encrypted_option_data_0"
                      - "encrypted_option_data_1"
                      - "fhe_encrypted_vote_data_0"
                empty:
                  summary: Sin votos
                  value:
                    encryptedResults: []

  /createElection:
    post:
      summary: üõ†Ô∏è Crear Nueva Elecci√≥n
      description: |
        Crea una nueva elecci√≥n en el smart contract.
        
        **Permisos:** Solo administradores con private key v√°lida.
        
        **Proceso:**
        1. Valida par√°metros de entrada
        2. Crea elecci√≥n en smart contract
        3. Retorna ID de elecci√≥n generado
      tags:
        - üõ†Ô∏è Admin
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateElectionRequest'
            examples:
              basicElection:
                summary: Elecci√≥n b√°sica
                value:
                  title: "Elecci√≥n Presidencial 2025"
                  description: "Elige al pr√≥ximo presidente"
                  options: ["Candidato A", "Candidato B", "Candidato C"]
                  durationHours: 168
                  enableFHE: false
              referendumElection:
                summary: Referendum
                value:
                  title: "Referendum Constitucional"
                  description: "¬øApruebas la nueva constituci√≥n?"
                  options: ["S√≠", "No"]
                  durationHours: 72
                  enableFHE: true
      responses:
        '200':
          description: ‚úÖ Elecci√≥n creada exitosamente
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CreateElectionResponse'
              examples:
                success:
                  summary: Elecci√≥n creada
                  value:
                    txHash: "0xbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb"
                    electionId: "3"
                    gasUsed: "245678"
        '400':
          description: ‚ùå Datos de entrada inv√°lidos
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                invalidOptions:
                  summary: Opciones insuficientes
                  value:
                    error: "invalid body"
                    details: "Minimum 2 options required"
        '401':
          description: ‚ùå No autorizado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: ‚ùå Error en blockchain
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /closeElection:
    post:
      summary: üîí Cerrar Elecci√≥n
      description: |
        Cierra una elecci√≥n activa, finalizando el per√≠odo de votaci√≥n.
        
        **Permisos:** Solo administradores.
        
        **Efecto:** Despu√©s de cerrar, no se pueden enviar m√°s votos.
      tags:
        - üõ†Ô∏è Admin
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CloseElectionRequest'
            examples:
              closeElection:
                summary: Cerrar elecci√≥n
                value:
                  electionId: "1"
      responses:
        '200':
          description: ‚úÖ Elecci√≥n cerrada exitosamente
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CloseElectionResponse'
              examples:
                success:
                  summary: Elecci√≥n cerrada
                  value:
                    txHash: "0xcccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccc"
        '400':
          description: ‚ùå ID de elecci√≥n inv√°lido
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: ‚ùå Elecci√≥n no encontrada
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '409':
          description: ‚ö†Ô∏è Elecci√≥n ya cerrada
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: ‚ùå Error en blockchain
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /activeElections:
    get:
      summary: üìã Obtener Elecciones Activas
      description: |
        Obtiene lista de IDs de todas las elecciones actualmente activas.
        
        **Filtro:** Solo elecciones con status = 0 (Active).
      tags:
        - üìä Query
      security: []
      responses:
        '200':
          description: ‚úÖ Lista obtenida exitosamente
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ActiveElectionsResponse'
              examples:
                withElections:
                  summary: Con elecciones activas
                  value:
                    ids: [1, 2, 5, 7]
                empty:
                  summary: Sin elecciones activas
                  value:
                    ids: []
        '500':
          description: ‚ùå Error consultando blockchain
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /electionInfo:
    get:
      summary: üìñ Obtener Informaci√≥n de Elecci√≥n
      description: |
        Obtiene informaci√≥n detallada de una elecci√≥n espec√≠fica.
        
        **Incluye:** T√≠tulo, descripci√≥n, fechas, estado, conteo de votos.
      tags:
        - üìä Query
      security: []
      parameters:
        - name: electionId
          in: query
          required: true
          schema:
            type: string
            pattern: '^[0-9]+$'
          description: ID de la elecci√≥n a consultar
          example: "1"
      responses:
        '200':
          description: ‚úÖ Informaci√≥n obtenida exitosamente
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ElectionInfoResponse'
              examples:
                activeElection:
                  summary: Elecci√≥n activa
                  value:
                    title: "Elecci√≥n Presidencial 2025"
                    description: "Elige al pr√≥ximo presidente del pa√≠s"
                    creator: "0xabc123def456789abc123def456789abc123def4"
                    startTime: 1693430400
                    endTime: 1694035200
                    status: 0
                    totalVotes: 1543
                    optionCount: 3
                closedElection:
                  summary: Elecci√≥n cerrada
                  value:
                    title: "Referendum Constitucional"
                    description: "¬øApruebas la nueva constituci√≥n?"
                    creator: "0xdef456abc789123def456abc789123def456abc7"
                    startTime: 1693344000
                    endTime: 1693603200
                    status: 1
                    totalVotes: 2847
                    optionCount: 2
        '400':
          description: ‚ùå ID de elecci√≥n faltante o inv√°lido
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: ‚ùå Elecci√≥n no encontrada
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: ‚ùå Error consultando blockchain
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /contractResults:
    get:
      summary: üìà Obtener Resultados de Elecci√≥n
      description: |
        Obtiene resultados completos de una elecci√≥n, incluyendo conteo de votos por opci√≥n.
        
        **Disponible:** Para elecciones activas y cerradas.
        **Tiempo real:** Los resultados se actualizan con cada voto.
      tags:
        - üìä Query
      security: []
      parameters:
        - name: electionId
          in: query
          required: true
          schema:
            type: string
            pattern: '^[0-9]+$'
          description: ID de la elecci√≥n
          example: "1"
      responses:
        '200':
          description: ‚úÖ Resultados obtenidos exitosamente
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ContractResultsResponse'
              examples:
                presidentialResults:
                  summary: Resultados presidenciales
                  value:
                    title: "Elecci√≥n Presidencial 2025"
                    description: "Elige al pr√≥ximo presidente del pa√≠s"
                    optionNames: ["Candidato A", "Candidato B", "Candidato C"]
                    voteCounts: [847, 523, 173]
                    totalVotes: 1543
                    status: 0
                    fheEnabled: false
                referendumResults:
                  summary: Resultados referendum
                  value:
                    title: "Referendum Constitucional"
                    description: "¬øApruebas la nueva constituci√≥n?"
                    optionNames: ["S√≠", "No"]
                    voteCounts: [1654, 1193]
                    totalVotes: 2847
                    status: 1
                    fheEnabled: true
        '400':
          description: ‚ùå ID de elecci√≥n faltante o inv√°lido
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: ‚ùå Elecci√≥n no encontrada
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: ‚ùå Error consultando blockchain
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

components:
  securitySchemes:
    ApiKeyAuth:
      type: apiKey
      in: header
      name: X-API-Key
      description: API Key para operaciones administrativas

  schemas:
    # Response Schemas
    HealthResponse:
      type: object
      properties:
        ok:
          type: boolean
          description: Estado del servicio
          example: true
      required:
        - ok

    SubmitVoteResponse:
      type: object
      properties:
        txHash:
          type: string
          description: Hash de la transacci√≥n en blockchain
          pattern: '^0x[a-fA-F0-9]{64}$'
          example: "0xaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa"
        blockNumber:
          type: integer
          description: N√∫mero del bloque donde se registr√≥
          minimum: 1
          example: 12345
        confirmed:
          type: boolean
          description: Estado de confirmaci√≥n
          example: true
        gasUsed:
          type: string
          description: Gas utilizado en la transacci√≥n
          example: "21000"
      required:
        - txHash
        - blockNumber
        - confirmed

    HasVotedResponse:
      type: object
      properties:
        hasVoted:
          type: boolean
          description: True si el usuario ya vot√≥
          example: false
      required:
        - hasVoted

    EncryptedResultsResponse:
      type: object
      properties:
        encryptedResults:
          type: array
          items:
            type: string
          description: Lista de votos cifrados
          example: ["encrypted_option_data_0", "encrypted_option_data_1"]
        count:
          type: integer
          description: Total de votos cifrados
          example: 2
      required:
        - encryptedResults

    CreateElectionResponse:
      type: object
      properties:
        txHash:
          type: string
          description: Hash de la transacci√≥n
          pattern: '^0x[a-fA-F0-9]{64}$'
          example: "0xbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb"
        electionId:
          type: string
          description: ID √∫nico de la elecci√≥n creada
          example: "3"
        gasUsed:
          type: string
          description: Gas utilizado
          example: "245678"
      required:
        - txHash
        - electionId

    CloseElectionResponse:
      type: object
      properties:
        txHash:
          type: string
          description: Hash de la transacci√≥n
          pattern: '^0x[a-fA-F0-9]{64}$'
          example: "0xcccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccc"
      required:
        - txHash

    ActiveElectionsResponse:
      type: object
      properties:
        ids:
          type: array
          items:
            type: integer
          description: IDs de elecciones activas
          example: [1, 2, 5, 7]
      required:
        - ids

    ElectionInfoResponse:
      type: object
      properties:
        title:
          type: string
          description: T√≠tulo de la elecci√≥n
          example: "Elecci√≥n Presidencial 2025"
        description:
          type: string
          description: Descripci√≥n detallada
          example: "Elige al pr√≥ximo presidente del pa√≠s"
        creator:
          type: string
          description: Direcci√≥n del creador
          pattern: '^0x[a-fA-F0-9]{40}$'
          example: "0xabc123def456789abc123def456789abc123def4"
        startTime:
          type: integer
          description: Timestamp de inicio (Unix)
          example: 1693430400
        endTime:
          type: integer
          description: Timestamp de fin (Unix)
          example: 1694035200
        status:
          type: integer
          description: Estado de la elecci√≥n
          enum: [0, 1]
          example: 0
        totalVotes:
          type: integer
          description: Total de votos recibidos
          minimum: 0
          example: 1543
        optionCount:
          type: integer
          description: N√∫mero de opciones
          minimum: 2
          example: 3
      required:
        - title
        - creator
        - startTime
        - endTime
        - status
        - totalVotes
        - optionCount

    ContractResultsResponse:
      type: object
      properties:
        title:
          type: string
          description: T√≠tulo de la elecci√≥n
          example: "Elecci√≥n Presidencial 2025"
        description:
          type: string
          description: Descripci√≥n de la elecci√≥n
          example: "Elige al pr√≥ximo presidente del pa√≠s"
        optionNames:
          type: array
          items:
            type: string
          description: Nombres de las opciones
          example: ["Candidato A", "Candidato B", "Candidato C"]
        voteCounts:
          type: array
          items:
            type: integer
            minimum: 0
          description: Votos por cada opci√≥n
          example: [847, 523, 173]
        totalVotes:
          type: integer
          description: Total de votos
          minimum: 0
          example: 1543
        status:
          type: integer
          description: Estado (0=Active, 1=Closed)
          enum: [0, 1]
          example: 0
        fheEnabled:
          type: boolean
          description: Si FHE est√° habilitado
          example: false
      required:
        - title
        - optionNames
        - voteCounts
        - totalVotes
        - status
        - fheEnabled

    # Request Schemas
    SubmitVoteRequest:
      type: object
      properties:
        electionId:
          type: string
          description: ID de la elecci√≥n
          pattern: '^[0-9]+$'
          example: "1"
        encryptedVote:
          type: string
          description: Voto cifrado
          minLength: 10
          example: "encrypted_option_data_0"
        walletAddress:
          type: string
          description: Direcci√≥n de wallet del votante
          pattern: '^0x[a-fA-F0-9]{40}$'
          example: "0x742d35Cc6601C1C8c7c3c3c3c3c3c3c3c3c3c3c"
      required:
        - electionId
        - encryptedVote
        - walletAddress

    CreateElectionRequest:
      type: object
      properties:
        title:
          type: string
          description: T√≠tulo de la elecci√≥n
          minLength: 3
          maxLength: 200
          example: "Elecci√≥n Presidencial 2025"
        description:
          type: string
          description: Descripci√≥n detallada (opcional)
          maxLength: 1000
          example: "Elige al pr√≥ximo presidente del pa√≠s"
        options:
          type: array
          items:
            type: string
            minLength: 1
            maxLength: 100
          minItems: 2
          maxItems: 10
          description: Opciones de votaci√≥n (min 2, max 10)
          example: ["Candidato A", "Candidato B", "Candidato C"]
        durationHours:
          type: integer
          description: Duraci√≥n en horas
          minimum: 1
          maximum: 8760
          example: 168
        enableFHE:
          type: boolean
          description: Habilitar cifrado FHE
          default: false
          example: false
      required:
        - title
        - options
        - durationHours

    CloseElectionRequest:
      type: object
      properties:
        electionId:
          type: string
          description: ID de la elecci√≥n a cerrar
          pattern: '^[0-9]+$'
          example: "1"
      required:
        - electionId

    # Error Schema
    ErrorResponse:
      type: object
      properties:
        error:
          type: string
          description: Mensaje de error
          example: "invalid body"
        details:
          type: string
          description: Detalles adicionales del error
          example: "Missing required field: electionId"
        code:
          type: string
          description: C√≥digo de error espec√≠fico
          example: "VALIDATION_ERROR"
        timestamp:
          type: string
          format: date-time
          description: Timestamp del error
          example: "2025-08-30T12:00:00Z"
      required:
        - error

tags:
  - name: üîç Health
    description: |
      Endpoints para verificar el estado del servicio.
      
      **Uso t√≠pico:** Health checks, monitoreo, load balancers.
  - name: üó≥Ô∏è Voting
    description: |
      Endpoints relacionados con el proceso de votaci√≥n.
      
      **Incluye:** Env√≠o de votos, verificaci√≥n de estado, votos cifrados.
  - name: üîê Encryption
    description: |
      Endpoints para manejo de cifrado y FHE (Fully Homomorphic Encryption).
      
      **Prop√≥sito:** Permitir votaci√≥n privada y procesamiento cifrado.
  - name: üõ†Ô∏è Admin
    description: |
      Endpoints administrativos que requieren permisos especiales.
      
      **Autenticaci√≥n:** Requiere private key v√°lida.
      **Funciones:** Crear y cerrar elecciones.
  - name: üìä Query
    description: |
      Endpoints de consulta para obtener informaci√≥n y resultados.
      
      **Acceso:** P√∫blico, no requiere autenticaci√≥n.
      **Datos:** Informaci√≥n de elecciones, resultados, listas.

externalDocs:
  description: üìö Documentaci√≥n completa del proyecto VoteCryp
  url: https://github.com/justinz12xd/VoteCryp/blob/main/README.md
